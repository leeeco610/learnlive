(function (window, document) {
	 var cp_header   = document.querySelector('.cp-main-header'),
       	 cp_menu     = document.querySelector('.cp-primary-nav'),
         cp_menuLink = document.querySelector('.cp-nav-trigger')
		 cp_main     = document.querySelector('.cp-main-content'),
		 cp_footer   = document.querySelector('.cp-footer'),
		 cp_searchLink=document.querySelector('.cp-search-trigger'),
		 cp_search   = document.querySelector('.cp-search'),
		 cp_body     = document.body,
		 cp_width	 =1024,
		 cp_overlay  = document.querySelector('.cp-overlay'),
		 cp_lang_list =document.querySelector('.lang-list'),
		 cp_submenu  = document.querySelector('.cp-menu');
	  //彈出菜單
	  cp_menuLink.onclick =function (e) {
		 if(event.preventDefault){event.preventDefault();}
		 else{event.returnValue = false;}
		 if(hasClass(cp_main,"nav-is-visible"))
		 {
			closeNav();
			removeClass(cp_overlay,'is-visible');
			removeClass(cp_submenu,'cp-menu-show');
			$('div.cp-dropmenu').removeClass('cp-menu-show');
			$('i.i-active').removeClass('i-active');
			$(".cp-mobile-chat").show();
			 }
		else
		{
			addClass(this,'nav-is-visible');
			addClass(cp_menu,'nav-is-visible');
			addClass(cp_header,'nav-is-visible');
			addClass(cp_main,'nav-is-visible');
			addClass(cp_footer,'nav-is-visible');
			addClass(cp_submenu,'cp-menu-show');
			var transitionEvent = whichTransitionEvent();
			transitionEvent && cp_footer.addEventListener(transitionEvent, function() {
				addClass(cp_body,'overflow-hidden');
			});	
			$(".cp-mobile-chat").hide();
			toggleSearch('close');
			addClass(cp_overlay,'is-visible'); 
			}
		  }
	function closeNav()
	{
		removeClass(cp_menuLink,"nav-is-visible");
		removeClass(cp_header,"nav-is-visible");
		removeClass(cp_menu,"nav-is-visible");
		removeClass(cp_main,"nav-is-visible");
		removeClass(cp_footer,"nav-is-visible");
		var transitionEvent = whichTransitionEvent();
			transitionEvent && cp_footer.addEventListener(transitionEvent, function() {
				removeClass(cp_body,'overflow-hidden');
			});	 
		//$("meta[name='viewport']").attr('content','width=device-width, initial-scale=1,user-scalable=1;')
		}
	//搜索
	cp_searchLink.onclick =function (e) {
		 if(event.preventDefault){event.preventDefault();}
		 else{event.returnValue = false;}
		toggleSearch();
		closeNav();
	}
	function toggleSearch(type) {
		if(type=="close") {
			removeClass(cp_search,'is-visible');
			removeClass(cp_searchLink,'search-is-visible');
			removeClass(cp_overlay,'search-is-visible');
		} else {
			//toggle search visibility
			toggleClass(cp_search,'is-visible');
			toggleClass(cp_searchLink,'search-is-visible');
		    toggleClass(cp_overlay,'search-is-visible');
			if(document.body.clientWidth < cp_width && hasClass(cp_search,'is-visible'))
			{
				 document.querySelector('#keyword').focus();
			}
			(hasClass(cp_search,'is-visible')) ? addClass(cp_overlay,'is-visible'):removeClass(cp_overlay,'is-visible');
		}
	}
	//submenu
	function hasClass(el,className)
	{	if (el.classList){return el.classList.contains(className);}
		else{return new RegExp('(^| )' + className + '( |$)', 'gi').test(el.className);}
	}
	function addClass(el,className)
	{
		if (el.classList){el.classList.add(className);}
		else{el.className += ' ' + className;}
	}
	function removeClass(el,className)
	{
		if (el.classList){el.classList.remove(className);}
		else{el.className = el.className.replace(new RegExp('(^|\\b)' + className.split(' ').join('|') + '(\\b|$)', 'gi'), ' ');}
	}
	function toggleClass(el,className)
	{
		if (el.classList) {el.classList.toggle(className);} 
		else {
			  var classes = el.className.split(' ');
			  var existingIndex = classes.indexOf(className);
			  if (existingIndex >= 0)
				classes.splice(existingIndex, 1);
			  else
				classes.push(className); el.className = classes.join(' ');
		}
	}
	//動畫完成
	function whichTransitionEvent(){
			    var t;
			    var el = document.createElement('conpakelement');
			    var transitions = {
			      'transition':'transitionend',
			      'OTransition':'oTransitionEnd',
			      'MozTransition':'transitionend',
			      'WebkitTransition':'webkitTransitionEnd'
			    }

			    for(t in transitions){
			        if( el.style[t] !== undefined ){
			            return transitions[t];
			        }
			    }
			}		 
}(this, this.document));
$(function(){
	$(window).on('resize', function(){
		checkWindowWidth();
	});
	function isPC(){  
           var userAgentInfo = navigator.userAgent;  
           var Agents = new Array("Android", "iPhone", "SymbianOS", "Windows Phone", "iPad", "iPod");  
           var flag = true;  
           for (var v = 0; v < Agents.length; v++) {  
               if (userAgentInfo.indexOf(Agents[v]) > 0) { flag = false; break; }  
           }  
           return flag;  
       } 
	$('.cp-menu').children('.has-children').children('a').on('click', function(event){
		if(!checkWindowWidth())
		{event.preventDefault();
		var selected = $(this);
		if(selected.next('div').hasClass('cp-dropmenu'))
		{
			selected.parent().siblings().children('div.cp-dropmenu').removeClass('cp-menu-show');
			selected.parent().siblings('.has-children').children('a').children('i').removeClass('i-active');
			selected.next('div').toggleClass('cp-menu-show');
			//selected.next('div').css('height',$(window).height());
			selected.children('i').first().toggleClass('i-active');
			
			}
		}
		else
		{
			if(!isPC())
			{
				event.preventDefault();
				$(this).parent().siblings().children('div.cp-dropmenu').hide();
				$(this).parent().siblings().removeClass('cp-ipad-menu');
				$(this).next('div').toggle();
				$(this).parent().toggleClass('cp-ipad-menu');
			}
		}
	});
	if(!isPC())
	{
		$(".cp-wch").click(function(){
			$('.cp-top-qr').toggle();
			});
		$("#cp-other-lang").click(function(){
			$('#cp-all-lang').toggle();
			$(this).toggleClass('cp-arrow-top');
			})
		}
	$('.cp-mobile-lang').click(function(){
			var langHtml='<ul class="mobile-lang"><li class="cp-m-back hidden-cp"><a href="javascript:void(0);">语言选择</a></li><li><a href="javascript:ChangeEn()"><i class="cp-eng"></i>English</a></li><li><a href="javascript:ChangeHk()"><i class="cp-hk"></i>繁體</a></li><li><a href="javascript:ChangeJa()"><i class="cp-ja"></i>日本語</a></li><li><a href="javascript:void(0);"><i class="cp-cn"></i>简体<i class="icon-checkmark icon-right"></i></a></li></ul>';
		if(! $('.lang-list').children('ul').hasClass('mobile-lang'))
		{$('.lang-list').append(langHtml);
		  $(".cp-m-back").click(function(){
			  if($(this).parent().parent().parent().hasClass('cp-dropmenu'))
				{
				$(this).parent().parent().parent().removeClass('cp-menu-show');
				}
				else
				{$(this).parent().parent().removeClass('cp-menu-show');
					}
				$(this).parent().parent().parent().parent().find('i').removeClass('i-active');
			  })
			}
		})
	$('.cp-menu-back').on('click', function(event){
		if($(this).parent().parent().parent().parent().hasClass('cp-dropmenu'))
		{
		$(this).parent().parent().parent().parent().removeClass('cp-menu-show');
		}
		else
		{$(this).parent().parent().parent().removeClass('cp-menu-show');
			}
		$(this).parent().parent().parent().parent().parent().find('i').removeClass('i-active');
	});
	$('.has-subli').children('a').on('click', function(event){
		if(!checkWindowWidth())
		{event.preventDefault();}
		var haveclass=$(this).next('ul').hasClass('cp-sub-show');
		$('.has-subli>ul').removeClass('cp-sub-show');
		if(haveclass)
		{
		$(this).next('ul').addClass('cp-sub-show');
		}
		$(this).next('ul').toggleClass('cp-sub-show');
	});

	function checkWindowWidth() {
		var e = window, 
		a = 'inner';
		if (!('innerWidth' in window )) {
		a = 'client';
		e = document.documentElement || document.body;
			}
		if ( e[ a+'Width' ] >= cp_width ) {return true;} 
		else {return false;}
	}
})